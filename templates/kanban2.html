<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban –î–æ—Å–∫–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .column {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .column-header {
            text-align: center;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 16px;
        }

        .backlog .column-header { background-color: #f5f5f5; color: #666; border-left: 4px solid #9e9e9e; }
        .todo .column-header { background-color: #e3f2fd; color: #1565c0; border-left: 4px solid #2196f3; }
        .in-progress .column-header { background-color: #fff3e0; color: #ef6c00; border-left: 4px solid #ff9800; }
        .done .column-header { background-color: #e8f5e8; color: #2e7d32; border-left: 4px solid #4caf50; }

        .task-list {
            min-height: 500px;
        }

        .task-card {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: move;
            transition: all 0.3s ease;
            position: relative;
        }

        .task-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .task-card.priority-high { border-left: 4px solid #f44336; }
        .task-card.priority-medium { border-left: 4px solid #ff9800; }
        .task-card.priority-low { border-left: 4px solid #4caf50; }

        .task-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
            color: #333;
        }

        .task-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .task-meta {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        .task-assignee {
            background-color: #e3f2fd;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            display: inline-block;
            margin-right: 5px;
        }

        .task-due-date {
            background-color: #fff3e0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            display: inline-block;
        }

        .task-due-date.overdue {
            background-color: #ffebee;
            color: #c62828;
        }

        .task-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .btn-edit {
            background-color: #2196f3;
            color: white;
        }

        .btn-edit:hover {
            background-color: #1976d2;
        }

        .btn-delete {
            background-color: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background-color: #d32f2f;
        }

        .add-task-btn {
            width: 100%;
            padding: 12px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .add-task-btn:hover {
            background-color: #45a049;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 600px;
            max-width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .form-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-cancel {
            background-color: #f5f5f5;
            color: #333;
        }

        .btn-submit {
            background-color: #2196f3;
            color: white;
        }

        .priority-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .priority-high { background-color: #ffebee; color: #c62828; }
        .priority-medium { background-color: #fff3e0; color: #ef6c00; }
        .priority-low { background-color: #e8f5e8; color: #2e7d32; }

        .task-list.over {
            background-color: #f0f8ff;
            border: 2px dashed #2196f3;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã Kanban –î–æ—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</h1>

        <div class="kanban-board">
            <div class="column backlog">
                <div class="column-header">üì• –ü–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</div>
                <div class="task-list" data-status="backlog"></div>
                <button class="add-task-btn" onclick="openModal('backlog')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>

            <div class="column todo">
                <div class="column-header">‚ö° –í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
                <div class="task-list" data-status="todo"></div>
                <button class="add-task-btn" onclick="openModal('todo')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>

            <div class="column in-progress">
                <div class="column-header">üìã –ù–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏</div>
                <div class="task-list" data-status="in-progress"></div>
                <button class="add-task-btn" onclick="openModal('in-progress')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>

            <div class="column done">
                <div class="column-header">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                <div class="task-list" data-status="done"></div>
                <button class="add-task-btn" onclick="openModal('done')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">

                <div class="form-group">
                    <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏ *</label>
                    <input type="text" id="title" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
                </div>

                <div class="form-group">
                    <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                    <textarea id="description" placeholder="–û–ø–∏—à–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="assignee">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                        <select id="assignee">
                            <option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
                            {% for assignee in assignees %}
                            <option value="{{ assignee }}">{{ assignee }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                        <select id="priority">
                            <option value="low">–ù–∏–∑–∫–∏–π</option>
                            <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
                            <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="due_date">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                        <input type="date" id="due_date">
                    </div>

                    <div class="form-group">
                        <label for="status">–°—Ç–∞—Ç—É—Å</label>
                        <select id="status">
                            <option value="backlog">–ü–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</option>
                            <option value="todo">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                            <option value="in-progress">–ù–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏</option>
                            <option value="done">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                        </select>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    let currentStatus = '';
    let isEditing = false;
    let draggedElement = null;
    let dragSource = null;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadTasks();
        initDragAndDrop();
    });

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function openModal(status = '') {
        currentStatus = status;
        isEditing = false;
        document.getElementById('modalTitle').textContent = '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
        document.getElementById('taskId').value = '';
        document.getElementById('title').value = '';
        document.getElementById('description').value = '';
        document.getElementById('assignee').value = '';
        document.getElementById('priority').value = 'medium';
        document.getElementById('due_date').value = '';
        document.getElementById('status').value = status || 'backlog';
        document.getElementById('taskModal').style.display = 'block';
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function closeModal() {
        document.getElementById('taskModal').style.display = 'none';
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á —Å —Å–µ—Ä–≤–µ—Ä–∞
    async function loadTasks() {
        try {
            const response = await fetch('/api/tasks');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const tasks = await response.json();

            // –û—á–∏—â–∞–µ–º –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏
            document.querySelectorAll('.task-list').forEach(column => {
                column.innerHTML = '';
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏
            tasks.forEach(task => {
                addTaskToColumn(task);
            });

            // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º drag-and-drop –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á
            initDragAndDrop();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á: ' + error.message);
        }
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ –∫–æ–ª–æ–Ω–∫—É
    function addTaskToColumn(task) {
        const column = document.querySelector(`.task-list[data-status="${task.status}"]`);
        if (!column) {
            console.error(`–ö–æ–ª–æ–Ω–∫–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "${task.status}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
            return;
        }

        const taskElement = document.createElement('div');
        taskElement.className = `task-card priority-${task.priority}`;
        taskElement.draggable = true;
        taskElement.dataset.taskId = task.id;
        taskElement.dataset.status = task.status;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á–∏
        const today = new Date().toISOString().split('T')[0];
        const dueDateClass = task.due_date && task.due_date < today ? 'overdue' : '';

        taskElement.innerHTML = `
            <div class="priority-badge priority-${task.priority}">
                ${getPriorityText(task.priority)}
            </div>
            <div class="task-title">${escapeHtml(task.title)}</div>
            <div class="task-description">${escapeHtml(task.description)}</div>

            <div class="task-meta">
                ${task.assignee ? `<span class="task-assignee">üë§ ${escapeHtml(task.assignee)}</span>` : ''}
                ${task.due_date ? `<span class="task-due-date ${dueDateClass}">üìÖ ${formatDate(task.due_date)}</span>` : ''}
            </div>

            <div class="task-meta">
                <small>–°–æ–∑–¥–∞–Ω–æ: ${formatDateTime(task.created_at)}</small>
                ${task.updated_at !== task.created_at ? `<br><small>–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${formatDateTime(task.updated_at)}</small>` : ''}
            </div>

            <div class="task-actions">
                <button class="btn btn-edit" onclick="editTask(${task.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-delete" onclick="deleteTask(${task.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
        `;

        column.appendChild(taskElement);
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
    function getPriorityText(priority) {
        const priorities = {
            'high': '–í—ã—Å–æ–∫–∏–π',
            'medium': '–°—Ä–µ–¥–Ω–∏–π',
            'low': '–ù–∏–∑–∫–∏–π'
        };
        return priorities[priority] || priority;
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString + 'T00:00:00');
        return date.toLocaleDateString('ru-RU');
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
    function formatDateTime(dateTimeString) {
        if (!dateTimeString) return '';
        const date = new Date(dateTimeString);
        return date.toLocaleString('ru-RU');
    }

    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag and drop
    function initDragAndDrop() {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        const taskCards = document.querySelectorAll('.task-card');
        const columns = document.querySelectorAll('.task-list');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        if (taskCards.length === 0 || columns.length === 0) {
            console.warn('No draggable elements found');
            return;
        }

        taskCards.forEach(card => {
            card.removeEventListener('dragstart', handleDragStart);
            card.removeEventListener('dragend', handleDragEnd);
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
        });

        columns.forEach(column => {
            column.removeEventListener('dragover', handleDragOver);
            column.removeEventListener('drop', handleDrop);
            column.removeEventListener('dragenter', handleDragEnter);
            column.removeEventListener('dragleave', handleDragLeave);

            column.addEventListener('dragover', handleDragOver);
            column.addEventListener('drop', handleDrop);
            column.addEventListener('dragenter', handleDragEnter);
            column.addEventListener('dragleave', handleDragLeave);
        });

        console.log('Drag and drop initialized');
    }

    function handleDragStart(e) {
        draggedElement = this;
        dragSource = this.parentNode;

        console.log('Drag start:', {
            taskId: this.dataset.taskId,
            source: this.parentNode.dataset.status
        });

        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π
        if (draggedElement) {
            draggedElement.style.opacity = '0.6';
        }

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.dataset.taskId);
    }

    function handleDragEnd(e) {
        console.log('Drag end');

        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π
        if (draggedElement) {
            draggedElement.style.opacity = '1';
        }

        // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫
        document.querySelectorAll('.task-list').forEach(col => {
            col.classList.remove('over');
        });

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
        draggedElement = null;
        dragSource = null;
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }

    function handleDrop(e) {
        e.preventDefault();
        console.log('Drop event');

        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ draggedElement
        if (!draggedElement) {
            console.error('No dragged element found');
            return;
        }

        // –ù–∞—Ö–æ–¥–∏–º —Ü–µ–ª–µ–≤—É—é –∫–æ–ª–æ–Ω–∫—É —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ drop
        let targetColumn = null;

        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∫–æ–ª–æ–Ω–∫—É —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
        if (e.target.classList.contains('task-list')) {
            targetColumn = e.target;
        } else if (e.target.closest('.task-list')) {
            targetColumn = e.target.closest('.task-list');
        } else {
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —á–µ—Ä–µ–∑ event.target, –∏—â–µ–º –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
            const columns = document.querySelectorAll('.task-list');
            for (let column of columns) {
                const rect = column.getBoundingClientRect();
                if (e.clientX >= rect.left && e.clientX <= rect.right &&
                    e.clientY >= rect.top && e.clientY <= rect.bottom) {
                    targetColumn = column;
                    break;
                }
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞—à–ª–∏ valid –∫–æ–ª–æ–Ω–∫—É
        if (!targetColumn || !targetColumn.dataset || !targetColumn.dataset.status) {
            console.error('Invalid target column:', targetColumn);
            if (draggedElement) {
                draggedElement.style.opacity = '1'; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
            }
            return;
        }

        const newStatus = targetColumn.dataset.status;
        const taskId = parseInt(draggedElement.dataset.taskId);

        console.log('Drop details:', {
            taskId: taskId,
            newStatus: newStatus,
            targetColumn: targetColumn
        });

        // –í–∏–∑—É–∞–ª—å–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
        targetColumn.appendChild(draggedElement);
        draggedElement.style.opacity = '1';
        targetColumn.classList.remove('over');

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        fetch(`/api/tasks/${taskId}/move`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => {
            if (!response.ok) {
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –æ–±—Ä–∞—Ç–Ω–æ
                if (dragSource && draggedElement) {
                    dragSource.appendChild(draggedElement);
                }
                return response.json().then(error => {
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                });
            }
            return response.json();
        })
        .then(updatedTask => {
            console.log('–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞:', updatedTask);
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            draggedElement.dataset.status = newStatus;
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + error.message);

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if (dragSource && draggedElement) {
                dragSource.appendChild(draggedElement);
                draggedElement.style.opacity = '1';
            }
        });

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        draggedElement = null;
        dragSource = null;
    }

    function handleDragEnter(e) {
        e.preventDefault();
        this.classList.add('over');
    }

    function handleDragLeave(e) {
        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å over —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–∞
        if (!this.contains(e.relatedTarget)) {
            this.classList.remove('over');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('taskForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const taskId = document.getElementById('taskId').value;
        const title = document.getElementById('title').value.trim();
        const description = document.getElementById('description').value.trim();
        const assignee = document.getElementById('assignee').value;
        const priority = document.getElementById('priority').value;
        const due_date = document.getElementById('due_date').value;
        const status = document.getElementById('status').value;

        if (!title) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏');
            return;
        }

        if (isEditing && taskId) {
            updateTask(parseInt(taskId), title, description, assignee, priority, due_date, status);
        } else {
            createTask(title, description, assignee, priority, due_date, status);
        }
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
    async function createTask(title, description, assignee, priority, due_date, status) {
        try {
            const response = await fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    description: description,
                    assignee: assignee || '',
                    priority: priority,
                    due_date: due_date || null,
                    status: status
                })
            });

            if (response.ok) {
                closeModal();
                await loadTasks();
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + error.message);
        }
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
    async function editTask(taskId) {
        try {
            const response = await fetch(`/api/tasks/${taskId}`);

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }

            const task = await response.json();

            isEditing = true;
            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É';
            document.getElementById('taskId').value = task.id;
            document.getElementById('title').value = task.title || '';
            document.getElementById('description').value = task.description || '';
            document.getElementById('assignee').value = task.assignee || '';
            document.getElementById('priority').value = task.priority || 'medium';
            document.getElementById('due_date').value = task.due_date || '';
            document.getElementById('status').value = task.status || 'backlog';
            document.getElementById('taskModal').style.display = 'block';

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á–∏: ' + error.message);
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
    async function updateTask(taskId, title, description, assignee, priority, due_date, status) {
        try {
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    description: description,
                    assignee: assignee || '',
                    priority: priority,
                    due_date: due_date || null,
                    status: status
                })
            });

            if (response.ok) {
                closeModal();
                await loadTasks();
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + error.message);
        }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
    async function deleteTask(taskId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) {
            return;
        }

        try {
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                await loadTasks();
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + error.message);
        }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    window.onclick = function(event) {
        const modal = document.getElementById('taskModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });
</script>
</body>
</html>