<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Доска</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5eb;
        }

        h1 {
            color: #2c3e50;
            font-size: 2.2rem;
        }

        .stats {
            display: flex;
            gap: 15px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-item {
            text-align: center;
            padding: 0 10px;
        }

        .stat-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .kanban-board {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .column {
            flex: 1;
            min-width: 280px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e1e5eb;
        }

        .column-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .task-count {
            background: #3498db;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .tasks-container {
            min-height: 400px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .task-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid #3498db;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }

        .task-card.high-priority {
            border-left-color: #e74c3c;
        }

        .task-card.medium-priority {
            border-left-color: #f39c12;
        }

        .task-card.low-priority {
            border-left-color: #27ae60;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .task-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .task-description {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #95a5a6;
        }

        .task-assignee {
            background: #ecf0f1;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .task-due-date {
            padding: 3px 6px;
            border-radius: 4px;
        }

        .task-due-date.overdue {
            background: #e74c3c;
            color: white;
        }

        .task-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .task-card:hover .task-actions {
            opacity: 1;
        }

        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }

        .btn-edit {
            background: #3498db;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .add-task-btn {
            width: 100%;
            padding: 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            transition: background-color 0.2s;
        }

        .add-task-btn:hover {
            background: #2980b9;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-cancel {
            background: #95a5a6;
            color: white;
        }

        .btn-save {
            background: #27ae60;
            color: white;
        }

        .dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .column.drag-over {
            background: #e8f4fc;
            border: 2px dashed #3498db;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 1100;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        @media (max-width: 768px) {
            .kanban-board {
                flex-direction: column;
            }

            .column {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Kanban Доска</h1>
            <div class="stats" id="stats">
                <!-- Статистика будет загружена через JavaScript -->
            </div>
        </header>

        <div class="kanban-board" id="kanbanBoard">
            <!-- Колонки будут созданы через JavaScript -->
        </div>
    </div>

    <!-- Модальное окно для создания/редактирования задачи -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <h2 id="modalTitle">Новая задача</h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">

                <div class="form-group">
                    <label for="taskTitle">Заголовок *</label>
                    <input type="text" id="taskTitle" required>
                </div>

                <div class="form-group">
                    <label for="taskDescription">Описание</label>
                    <textarea id="taskDescription"></textarea>
                </div>

                <div class="form-group">
                    <label for="taskAssignee">Исполнитель</label>
                    <select id="taskAssignee">
                        <option value="">Не назначен</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="taskPriority">Приоритет</label>
                    <select id="taskPriority">
                        <option value="high">Высокий</option>
                        <option value="medium" selected>Средний</option>
                        <option value="low">Низкий</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="taskDueDate">Срок выполнения</label>
                    <input type="date" id="taskDueDate">
                </div>

                <div class="form-group">
                    <label for="taskStatus">Статус</label>
                    <select id="taskStatus">
                        <option value="backlog">Бэклог</option>
                        <option value="todo">К выполнению</option>
                        <option value="in-progress">В работе</option>
                        <option value="done">Выполнено</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancelBtn">Отмена</button>
                    <button type="submit" class="btn btn-save">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Уведомления -->
    <div class="notification" id="notification"></div>

    <script>
        // Конфигурация колонок
        const columnsConfig = [
            { id: 'backlog', title: 'Бэклог', status: 'backlog' },
            { id: 'todo', title: 'К выполнению', status: 'todo' },
            { id: 'in-progress', title: 'В работе', status: 'in-progress' },
            { id: 'done', title: 'Выполнено', status: 'done' }
        ];

        // Глобальные переменные
        let tasks = [];
        let assignees = [];
        let currentEditingTask = null;

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initializeBoard();
            loadTasks();
            loadAssignees();
            loadStats();
            setupEventListeners();
        });

        // Инициализация доски
        function initializeBoard() {
            const board = document.getElementById('kanbanBoard');

            columnsConfig.forEach(column => {
                const columnElement = document.createElement('div');
                columnElement.className = 'column';
                columnElement.id = column.id;
                columnElement.dataset.status = column.status;

                columnElement.innerHTML = `
                    <div class="column-header">
                        <div class="column-title">${column.title}</div>
                        <div class="task-count">0</div>
                    </div>
                    <div class="tasks-container" data-status="${column.status}">
                        <!-- Задачи будут добавляться сюда -->
                    </div>
                    <button class="add-task-btn" data-status="${column.status}">+ Добавить задачу</button>
                `;

                board.appendChild(columnElement);
            });
        }

        // Загрузка задач
        async function loadTasks() {
            try {
                const response = await fetch('/api/tasks');
                if (response.ok) {
                    tasks = await response.json();
                    renderTasks();
                    updateColumnCounts();
                } else {
                    showNotification('Ошибка загрузки задач', 'error');
                }
            } catch (error) {
                showNotification('Ошибка загрузки задач: ' + error.message, 'error');
            }
        }

        // Загрузка исполнителей
        async function loadAssignees() {
            try {
                const response = await fetch('/api/assignees');
                if (response.ok) {
                    assignees = await response.json();
                    updateAssigneeSelect();
                }
            } catch (error) {
                console.error('Ошибка загрузки исполнителей:', error);
            }
        }

        // Загрузка статистики
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                if (response.ok) {
                    const stats = await response.json();
                    renderStats(stats);
                }
            } catch (error) {
                console.error('Ошибка загрузки статистики:', error);
            }
        }

        // Отображение статистики
        function renderStats(stats) {
            const statsContainer = document.getElementById('stats');
            const totalTasks = stats.reduce((sum, stat) => sum + stat.count, 0);
            const overdueTasks = stats.reduce((sum, stat) => sum + (stat.overdue || 0), 0);

            statsContainer.innerHTML = `
                <div class="stat-item">
                    <div class="stat-count">${totalTasks}</div>
                    <div class="stat-label">Всего задач</div>
                </div>
                <div class="stat-item">
                    <div class="stat-count">${overdueTasks}</div>
                    <div class="stat-label">Просрочено</div>
                </div>
            `;

            // Добавляем статистику по колонкам
            columnsConfig.forEach(column => {
                const columnStat = stats.find(stat => stat.status === column.status);
                if (columnStat) {
                    statsContainer.innerHTML += `
                        <div class="stat-item">
                            <div class="stat-count">${columnStat.count}</div>
                            <div class="stat-label">${column.title}</div>
                        </div>
                    `;
                }
            });
        }

        // Обновление выпадающего списка исполнителей
        function updateAssigneeSelect() {
            const select = document.getElementById('taskAssignee');
            select.innerHTML = '<option value="">Не назначен</option>';

            assignees.forEach(assignee => {
                const option = document.createElement('option');
                option.value = assignee;
                option.textContent = assignee;
                select.appendChild(option);
            });
        }

        // Отображение задач на доске
        function renderTasks() {
            // Очищаем все колонки
            document.querySelectorAll('.tasks-container').forEach(container => {
                container.innerHTML = '';
            });

            // Добавляем задачи в соответствующие колонки
            tasks.forEach(task => {
                const container = document.querySelector(`.tasks-container[data-status="${task.status}"]`);
                if (container) {
                    container.appendChild(createTaskCard(task));
                }
            });

            setupDragAndDrop();
        }

        // Создание карточки задачи
        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = `task-card ${task.priority}-priority`;
            card.draggable = true;
            card.dataset.taskId = task.id;

            const today = new Date();
            const dueDate = task.due_date ? new Date(task.due_date) : null;
            const isOverdue = dueDate && dueDate < today;

            card.innerHTML = `
                <div class="task-header">
                    <div class="task-title">${escapeHtml(task.title)}</div>
                </div>
                ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
                <div class="task-meta">
                    <div class="task-assignee">${task.assignee || 'Не назначен'}</div>
                    ${dueDate ? `<div class="task-due-date ${isOverdue ? 'overdue' : ''}">${formatDate(dueDate)}</div>` : ''}
                </div>
                <div class="task-actions">
                    <button class="btn btn-edit" onclick="editTask(${task.id})">Изменить</button>
                    <button class="btn btn-delete" onclick="deleteTask(${task.id})">Удалить</button>
                </div>
            `;

            return card;
        }

        // Обновление счетчиков задач в колонках
        function updateColumnCounts() {
            columnsConfig.forEach(column => {
                const count = tasks.filter(task => task.status === column.status).length;
                const countElement = document.querySelector(`#${column.id} .task-count`);
                if (countElement) {
                    countElement.textContent = count;
                }
            });
        }

        // Настройка drag and drop
        function setupDragAndDrop() {
            const taskCards = document.querySelectorAll('.task-card');
            const columns = document.querySelectorAll('.column');

            taskCards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
                column.addEventListener('drop', handleDrop);
            });
        }

        // Обработчики drag and drop
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.column').forEach(col => col.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.target.closest('.column').classList.add('drag-over');
        }

        function handleDragLeave(e) {
            if (!e.target.closest('.column')) {
                e.target.closest('.column').classList.remove('drag-over');
            }
        }

        async function handleDrop(e) {
            e.preventDefault();
            const column = e.target.closest('.column');
            column.classList.remove('drag-over');

            const taskId = e.dataTransfer.getData('text/plain');
            const newStatus = column.dataset.status;

            try {
                const response = await fetch(`/api/tasks/${taskId}/move`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    await loadTasks();
                    showNotification('Задача перемещена', 'success');
                } else {
                    showNotification('Ошибка перемещения задачи', 'error');
                }
            } catch (error) {
                showNotification('Ошибка перемещения задачи: ' + error.message, 'error');
            }
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Кнопки добавления задач
            document.querySelectorAll('.add-task-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openTaskModal(this.dataset.status);
                });
            });

            // Модальное окно
            document.getElementById('cancelBtn').addEventListener('click', closeTaskModal);
            document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);

            // Закрытие модального окна по клику вне его
            document.getElementById('taskModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTaskModal();
                }
            });
        }

        // Открытие модального окна для создания/редактирования задачи
        function openTaskModal(status = 'backlog') {
            currentEditingTask = null;
            document.getElementById('modalTitle').textContent = 'Новая задача';
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = '';
            document.getElementById('taskStatus').value = status;
            document.getElementById('taskModal').style.display = 'flex';
        }

        // Редактирование задачи
        window.editTask = async function(taskId) {
            try {
                const response = await fetch(`/api/tasks/${taskId}`);
                if (response.ok) {
                    const task = await response.json();
                    currentEditingTask = task;

                    document.getElementById('modalTitle').textContent = 'Редактировать задачу';
                    document.getElementById('taskId').value = task.id;
                    document.getElementById('taskTitle').value = task.title;
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskAssignee').value = task.assignee || '';
                    document.getElementById('taskPriority').value = task.priority;
                    document.getElementById('taskDueDate').value = task.due_date || '';
                    document.getElementById('taskStatus').value = task.status;

                    document.getElementById('taskModal').style.display = 'flex';
                } else {
                    showNotification('Ошибка загрузки задачи', 'error');
                }
            } catch (error) {
                showNotification('Ошибка загрузки задачи: ' + error.message, 'error');
            }
        }

        // Закрытие модального окна
        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            currentEditingTask = null;
        }

        // Обработка отправки формы
        async function handleTaskSubmit(e) {
            e.preventDefault();

            const taskData = {
                title: document.getElementById('taskTitle').value.trim(),
                description: document.getElementById('taskDescription').value.trim(),
                assignee: document.getElementById('taskAssignee').value,
                priority: document.getElementById('taskPriority').value,
                due_date: document.getElementById('taskDueDate').value || null,
                status: document.getElementById('taskStatus').value
            };

            if (!taskData.title) {
                showNotification('Заголовок обязателен', 'error');
                return;
            }

            const taskId = document.getElementById('taskId').value;
            const url = taskId ? `/api/tasks/${taskId}` : '/api/tasks';
            const method = taskId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskData)
                });

                if (response.ok) {
                    closeTaskModal();
                    await loadTasks();
                    await loadStats();
                    showNotification(taskId ? 'Задача обновлена' : 'Задача создана', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Ошибка сохранения задачи', 'error');
                }
            } catch (error) {
                showNotification('Ошибка сохранения задачи: ' + error.message, 'error');
            }
        }

        // Удаление задачи
        window.deleteTask = async function(taskId) {
            if (!confirm('Вы уверены, что хотите удалить эту задачу?')) {
                return;
            }

            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadTasks();
                    await loadStats();
                    showNotification('Задача удалена', 'success');
                } else {
                    showNotification('Ошибка удаления задачи', 'error');
                }
            } catch (error) {
                showNotification('Ошибка удаления задачи: ' + error.message, 'error');
            }
        }

        // Показать уведомление
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Вспомогательные функции
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(date) {
            return date.toLocaleDateString('ru-RU');
        }
    </script>
</body>
</html>